/* Copyright 2022 UCLouvain, Belgium and PQM4 contributors
 *
 * This file is part of pqm4_masked.
 *
 * pqm4_masked is free software: you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free
 * Software Foundation, version 3.
 *
 * pqm4_masked is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * pqm4_masked. If not, see <https://www.gnu.org/licenses/>.
 */
#include "indcpa.h"
#include "masked.h"
#include "masked_utils.h"
#include "ntt.h"
#include "params.h"
#include "poly.h"

#include <stdint.h>
#include <string.h>



/*************************************************
 * Name:        masked_indcpa_dec
 *
 * Description: Decryption function of the CPA-secure
 *              public-key encryption scheme underlying Kyber.
 *
 * Arguments:   - unsigned char *m:        pointer to output decrypted message
 *(of length KYBER_INDCPA_MSGBYTES)
 *              - const unsigned char *c:  pointer to input ciphertext (of
 *length KYBER_INDCPA_BYTES)
 *              - const unsigned char *sk: pointer to input secret key (of
 *length KYBER_INDCPA_SECRETKEYBYTES)
 **************************************************/
void __attribute__((noinline))
masked_indcpa_dec(unsigned char *m, // secret
                  const unsigned char *c,    // public
                  const unsigned char *sk) { // secret
  poly mp, psk;
  StrAPoly masked_psk, masked_mp;
  int d;
  poly_unpackdecompress(&mp, c, 0);
  poly_ntt(&mp);

  // TODO store masked version of the private key
  // mask private key
  poly_frombytes(&psk, sk);
  masked_poly(masked_psk, &psk);

  trigger_high();

  for (d = 0; d < NSHARES; d++) {
    poly_basemul_i16(masked_mp[d], mp.coeffs, masked_psk[d]);
  }

  trigger_low();

  return;
}


#ifdef DEBUG
masked_indcpa_basemul(unsigned char *m, // secret
                      const unsigned char *c,    // public
                      const unsigned char *sk) { // secret
  poly mp, psk;
  StrAPoly masked_psk, masked_mp;
  int d;
  poly_unpackdecompress(&mp, c, 0);
  poly_ntt(&mp);


  // TODO store masked version of the private key
  // mask private key
  poly_frombytes(&psk, sk);
  //masked_poly(masked_psk, &psk);

  poly_basemul_i16(masked_mp[0], mp.coeffs, psk.coeffs);

  for (int i = 0; i < 16; i++) {
    for (int j = 0; j < 2; j++)
      m[i*2 + j] = masked_mp[0][i] >> (8*j);
  }

  return;
}
#endif